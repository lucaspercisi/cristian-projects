{% extends "base.html" %}

{% block title %}Análise de Cotações{% endblock %}

{% block page_title %}Análise de Cotações{% endblock %}

{% block content %}
<div class="bg-white p-8 rounded-xl shadow-2xl transition-all duration-300">
    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b-2 border-indigo-600 pb-2">Cotação e Análise de Fretes</h2>
    <p class="text-sm text-gray-600 mb-6">Insira as informações de cotação de cada transportadora para analisar a melhor opção de **preço total (em R$ estimado)** e **prazo**.</p>

    <form id="cotacaoForm" class="space-y-6">

        <div class="border border-gray-200 rounded-lg p-6 bg-gray-50">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Transportadora 1</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                <div>
                    <label for="transportadora1" class="block text-sm font-medium text-gray-700">Nome da Transportadora</label>
                    <input type="text" id="transportadora1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-600 focus:ring-4 focus:ring-indigo-200 sm:text-sm p-2">
                </div>
                <div>
                    <label for="prazo1" class="block text-sm font-medium text-gray-700">Prazo de Entrega (dias)</label>
                    <input type="number" id="prazo1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-600 focus:ring-4 focus:ring-indigo-200 sm:text-sm p-2">
                </div>
            </div>

            <h4 class="text-lg font-semibold text-gray-700 mt-6 mb-3 border-t pt-4">Custos Detalhados (Para cálculo do Total R$)</h4>
            
            <div class="grid grid-cols-4 gap-3 text-sm font-medium text-gray-700 mb-1">
                <div class="font-bold">Tipo de Custo</div>
                <div class="font-bold text-right">R$</div>
                <div class="font-bold text-right">USD</div>
                <div class="font-bold text-right">EUR</div>
            </div>

            <div class="grid grid-cols-4 gap-3 mb-2">
                <label class="text-sm text-gray-700 mt-1">Custo de Frete</label>
                <input type="number" step="0.01" id="freteRS1" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                <input type="number" step="0.01" id="freteUSD1" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                <input type="number" step="0.01" id="freteEUR1" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
            </div>

            <div class="grid grid-cols-4 gap-3 mb-2">
                <label class="text-sm text-gray-700 mt-1">Custos Origem</label>
                <input type="number" step="0.01" id="origemRS1" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                <input type="number" step="0.01" id="origemUSD1" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                <input type="number" step="0.01" id="origemEUR1" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
            </div>

            <div class="grid grid-cols-4 gap-3 mb-2">
                <label class="text-sm text-gray-700 mt-1">Custos Destino</label>
                <input type="number" step="0.01" id="destinoRS1" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                <input type="number" step="0.01" id="destinoUSD1" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                <input type="number" step="0.01" id="destinoEUR1" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
            </div>

            <div class="mt-6 border-t pt-4 grid grid-cols-4 gap-3">
                <div class="col-span-1 text-sm font-medium text-gray-700 self-center">Câmbio de Referência</div>
                <div>
                    <label for="cambioRefUSD1" class="block text-xs font-normal text-gray-500">1 USD = R$</label>
                    <input type="number" step="0.0001" id="cambioRefUSD1" value="5.0000" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                </div>
                <div>
                    <label for="cambioRefEUR1" class="block text-xs font-normal text-gray-500">1 EUR = R$</label>
                    <input type="number" step="0.0001" id="cambioRefEUR1" value="5.5000" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                </div>
                <div class="text-right">
                    <label class="block text-sm font-semibold text-gray-700">CUSTO TOTAL (R$ Est.)</label>
                    <span id="custoTotalRS1" class="text-xl font-bold text-indigo-600 block mt-1">0,00</span>
                </div>
            </div>
        </div>
        <div class="border border-gray-200 rounded-lg p-6 bg-gray-50">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Transportadora 2</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                <div>
                    <label for="transportadora2" class="block text-sm font-medium text-gray-700">Nome da Transportadora</label>
                    <input type="text" id="transportadora2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-600 focus:ring-4 focus:ring-indigo-200 sm:text-sm p-2">
                </div>
                <div>
                    <label for="prazo2" class="block text-sm font-medium text-gray-700">Prazo de Entrega (dias)</label>
                    <input type="number" id="prazo2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-600 focus:ring-4 focus:ring-indigo-200 sm:text-sm p-2">
                </div>
            </div>

            <h4 class="text-lg font-semibold text-gray-700 mt-6 mb-3 border-t pt-4">Custos Detalhados (Para cálculo do Total R$)</h4>
            
            <div class="grid grid-cols-4 gap-3 text-sm font-medium text-gray-700 mb-1">
                <div class="font-bold">Tipo de Custo</div>
                <div class="font-bold text-right">R$</div>
                <div class="font-bold text-right">USD</div>
                <div class="font-bold text-right">EUR</div>
            </div>

            <div class="grid grid-cols-4 gap-3 mb-2">
                <label class="text-sm text-gray-700 mt-1">Custo de Frete</label>
                <input type="number" step="0.01" id="freteRS2" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                <input type="number" step="0.01" id="freteUSD2" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                <input type="number" step="0.01" id="freteEUR2" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
            </div>

            <div class="grid grid-cols-4 gap-3 mb-2">
                <label class="text-sm text-gray-700 mt-1">Custos Origem</label>
                <input type="number" step="0.01" id="origemRS2" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                <input type="number" step="0.01" id="origemUSD2" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                <input type="number" step="0.01" id="origemEUR2" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
            </div>

            <div class="grid grid-cols-4 gap-3 mb-2">
                <label class="text-sm text-gray-700 mt-1">Custos Destino</label>
                <input type="number" step="0.01" id="destinoRS2" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                <input type="number" step="0.01" id="destinoUSD2" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                <input type="number" step="0.01" id="destinoEUR2" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
            </div>

            <div class="mt-6 border-t pt-4 grid grid-cols-4 gap-3">
                <div class="col-span-1 text-sm font-medium text-gray-700 self-center">Câmbio de Referência</div>
                <div>
                    <label for="cambioRefUSD2" class="block text-xs font-normal text-gray-500">1 USD = R$</label>
                    <input type="number" step="0.0001" id="cambioRefUSD2" value="5.0000" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                </div>
                <div>
                    <label for="cambioRefEUR2" class="block text-xs font-normal text-gray-500">1 EUR = R$</label>
                    <input type="number" step="0.0001" id="cambioRefEUR2" value="5.5000" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                </div>
                <div class="text-right">
                    <label class="block text-sm font-semibold text-gray-700">CUSTO TOTAL (R$ Est.)</label>
                    <span id="custoTotalRS2" class="text-xl font-bold text-indigo-600 block mt-1">0,00</span>
                </div>
            </div>
        </div>
        <div class="border border-gray-200 rounded-lg p-6 bg-gray-50">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Transportadora 3</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                <div>
                    <label for="transportadora3" class="block text-sm font-medium text-gray-700">Nome da Transportadora</label>
                    <input type="text" id="transportadora3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-600 focus:ring-4 focus:ring-indigo-200 sm:text-sm p-2">
                </div>
                <div>
                    <label for="prazo3" class="block text-sm font-medium text-gray-700">Prazo de Entrega (dias)</label>
                    <input type="number" id="prazo3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-600 focus:ring-4 focus:ring-indigo-200 sm:text-sm p-2">
                </div>
            </div>

            <h4 class="text-lg font-semibold text-gray-700 mt-6 mb-3 border-t pt-4">Custos Detalhados (Para cálculo do Total R$)</h4>
            
            <div class="grid grid-cols-4 gap-3 text-sm font-medium text-gray-700 mb-1">
                <div class="font-bold">Tipo de Custo</div>
                <div class="font-bold text-right">R$</div>
                <div class="font-bold text-right">USD</div>
                <div class="font-bold text-right">EUR</div>
            </div>

            <div class="grid grid-cols-4 gap-3 mb-2">
                <label class="text-sm text-gray-700 mt-1">Custo de Frete</label>
                <input type="number" step="0.01" id="freteRS3" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                <input type="number" step="0.01" id="freteUSD3" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                <input type="number" step="0.01" id="freteEUR3" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
            </div>

            <div class="grid grid-cols-4 gap-3 mb-2">
                <label class="text-sm text-gray-700 mt-1">Custos Origem</label>
                <input type="number" step="0.01" id="origemRS3" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                <input type="number" step="0.01" id="origemUSD3" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                <input type="number" step="0.01" id="origemEUR3" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
            </div>

            <div class="grid grid-cols-4 gap-3 mb-2">
                <label class="text-sm text-gray-700 mt-1">Custos Destino</label>
                <input type="number" step="0.01" id="destinoRS3" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                <input type="number" step="0.01" id="destinoUSD3" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                <input type="number" step="0.01" id="destinoEUR3" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
            </div>

            <div class="mt-6 border-t pt-4 grid grid-cols-4 gap-3">
                <div class="col-span-1 text-sm font-medium text-gray-700 self-center">Câmbio de Referência</div>
                <div>
                    <label for="cambioRefUSD3" class="block text-xs font-normal text-gray-500">1 USD = R$</label>
                    <input type="number" step="0.0001" id="cambioRefUSD3" value="5.0000" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                </div>
                <div>
                    <label for="cambioRefEUR3" class="block text-xs font-normal text-gray-500">1 EUR = R$</label>
                    <input type="number" step="0.0001" id="cambioRefEUR3" value="5.5000" class="text-right p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                </div>
                <div class="text-right">
                    <label class="block text-sm font-semibold text-gray-700">CUSTO TOTAL (R$ Est.)</label>
                    <span id="custoTotalRS3" class="text-xl font-bold text-indigo-600 block mt-1">0,00</span>
                </div>
            </div>
        </div>
        <div class="flex justify-end space-x-4 mt-6">
            <button type="button" onclick="analisarCotacoes()" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                Analisar
            </button>
        </div>

        <div id="analiseResultados" class="hidden mt-8 border-t-2 border-gray-300 pt-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Resultado da Análise</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-green-100 p-4 rounded-lg shadow-md border-2 border-green-500">
                    <h4 class="text-lg font-semibold text-green-700">Melhor Preço (Total R$ Est.)</h4>
                    <p id="melhorPreco" class="mt-2 text-2xl font-bold text-green-900"></p>
                </div>
                <div class="bg-blue-100 p-4 rounded-lg shadow-md border-2 border-blue-500">
                    <h4 class="text-lg font-semibold text-blue-700">Melhor Prazo</h4>
                    <p id="melhorPrazo" class="mt-2 text-2xl font-bold text-blue-900"></p>
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-4">* O valor total em R$ é uma estimativa calculada com base nos câmbios informados para USD/R$ e EUR/R$.</p>
        </div>

    </form>
</div>

<script>
    function analisarCotacoes() {
        // Função auxiliar para obter o valor e garantir que é um número (ou 0 se for inválido)
        const parseValue = (id) => {
            const element = document.getElementById(id);
            if (!element) return 0;
            const value = element.value.replace(',', '.'); // Permite entrada com vírgula como decimal
            return parseFloat(value) || 0;
        };

        const cotacoes = [];

        for (let i = 1; i <= 3; i++) {
            const transportadora = document.getElementById(`transportadora${i}`).value;
            const prazo = parseValue(`prazo${i}`);
            
            // 1. Obter taxas de câmbio
            const cambioUSD = parseValue(`cambioRefUSD${i}`);
            const cambioEUR = parseValue(`cambioRefEUR${i}`);
            
            // 2. Obter custos por moeda e tipo
            // R$ Costs
            const freteRS = parseValue(`freteRS${i}`);
            const origemRS = parseValue(`origemRS${i}`);
            const destinoRS = parseValue(`destinoRS${i}`);
            
            // USD Costs
            const freteUSD = parseValue(`freteUSD${i}`);
            const origemUSD = parseValue(`origemUSD${i}`);
            const destinoUSD = parseValue(`destinoUSD${i}`);
            
            // EUR Costs
            const freteEUR = parseValue(`freteEUR${i}`);
            const origemEUR = parseValue(`origemEUR${i}`);
            const destinoEUR = parseValue(`destinoEUR${i}`);
            
            // 3. Calcular Total Cost in R$
            let totalRS = 0;
            
            // Componente R$
            totalRS += freteRS + origemRS + destinoRS;
            
            // Componente USD (convertido para R$)
            const totalUSD = freteUSD + origemUSD + destinoUSD;
            if (totalUSD > 0 && cambioUSD > 0) {
                totalRS += (totalUSD * cambioUSD);
            }

            // Componente EUR (convertido para R$)
            const totalEUR = freteEUR + origemEUR + destinoEUR;
            if (totalEUR > 0 && cambioEUR > 0) {
                totalRS += (totalEUR * cambioEUR);
            }

            // 4. Atualizar o display do total calculado na transportadora
            document.getElementById(`custoTotalRS${i}`).textContent = totalRS.toFixed(2).replace('.', ',');

            // 5. Adicionar aos dados de análise se o nome da transportadora foi preenchido
            if (transportadora.trim() !== '') {
                cotacoes.push({ 
                    transportadora, 
                    prazo, 
                    valor: totalRS 
                });
            }
        }

        // Lógica de análise de resultados (mantida do seu código original)
        let melhorPreco = null;
        let melhorPrazo = null;

        // Filtra cotações com valores válidos para comparação
        const cotacoesValidas = cotacoes.filter(c => c.valor > 0 && c.prazo > 0);

        cotacoesValidas.forEach(c => {
            // Melhor Preço: menor valor
            if (melhorPreco === null || c.valor < melhorPreco.valor) {
                melhorPreco = c;
            }
            // Melhor Prazo: menor prazo
            if (melhorPrazo === null || c.prazo < melhorPrazo.prazo) {
                melhorPrazo = c;
            }
        });

        const resultadosDiv = document.getElementById('analiseResultados');
        resultadosDiv.classList.remove('hidden');

        if (melhorPreco) {
            document.getElementById('melhorPreco').textContent = `${melhorPreco.transportadora}: R$ ${melhorPreco.valor.toFixed(2).replace('.', ',')}`;
        } else {
            document.getElementById('melhorPreco').textContent = 'Nenhuma cotação de preço válida encontrada.';
        }

        if (melhorPrazo) {
            document.getElementById('melhorPrazo').textContent = `${melhorPrazo.transportadora}: ${melhorPrazo.prazo} dias`;
        } else {
            document.getElementById('melhorPrazo').textContent = 'Nenhuma cotação de prazo válida encontrada.';
        }
    }
</script>
{% endblock %}